

# Start kube2sky glue
docker run -d --net=host --restart=always gcr.io/google_containers/kube2sky:1.11 -v=10 -logtostderr=true -domain=kubernetes.local -etcd-server="http://127.0.0.1:2379"


# install skydns and configure and start
dnf install skydns --enablerepo=updates-testing
#edit /etc/skydns/skydns.conf
ETCD_MACHINES="http://127.0.0.1:2379"
SKYDNS_DOMAIN="kubernetes.local"
SKYDNS_ADDR="0.0.0.0:53"
SKYDNS_NAMESERVERS="8.8.8.8:53,8.8.4.4:53"
# Need to run as root for port 53 because kubelet can't accept a --cluster_dns with a port
sed /User=skydns/d /usr/lib/systemd/system/skydns.service > /etc/systemd/system/skydns.service 
systemctl daemon-reload
systemctl start skydns.service
systemctl enable skydns.service

#edit /etc/kubernetes/kubelet
KUBELET_ARGS="--cluster_dns=192.168.121.149 --cluster_domain=kubernetes.local"
systemctl restart kubelet.service


cat > /tmp/busybox.yaml <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: busybox
  namespace: default
spec:
  containers:
  - image: busybox
    command:
      - sleep
      - "3600"
    imagePullPolicy: IfNotPresent
    name: busybox
  restartPolicy: Always
EOF

kubectl create -f /tmp/busybox.yaml
kubectl exec busybox -- nslookup kubernetes
